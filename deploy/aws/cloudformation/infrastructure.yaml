AWSTemplateFormatVersion: '2010-09-09'
Description: 'WhatsApp Business API Infrastructure - Complete serverless stack with RDS, DynamoDB, S3, and App Runner'

# ================================
# PARAMETERS
# ================================
Parameters:
  Environment:
    Type: String
    Default: development
    AllowedValues: [development, staging, production]
    Description: Environment name (affects resource sizing and configuration)
  
  WhatsAppToken:
    Type: String
    NoEcho: true
    Description: WhatsApp Business API Token from Meta Developer Console
  
  VerifyToken:
    Type: String
    NoEcho: true
    Description: WhatsApp Webhook Verify Token for webhook validation
  
  GitHubConnectionArn:
    Type: String
    Description: ARN of the App Runner connection to GitHub (create this manually in AWS Console first)
  
  GitHubRepositoryUrl:
    Type: String
    Description: Full GitHub repository URL
    Default: "https://github.com/therealabhishekc/goblin"
  
  GitHubBranch:
    Type: String
    Description: GitHub branch to deploy from
    Default: "main"

  DefaultVPCId:
    Type: AWS::EC2::VPC::Id
    Description: Default VPC ID (find this in AWS Console > VPC > Your VPCs)

  AllowedCIDR:
    Type: String
    Description: CIDR block to allow PostgreSQL access (use your office/VPN IP for security)
    Default: "0.0.0.0/0"
    AllowedPattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
    ConstraintDescription: Must be a valid CIDR block (e.g., 203.0.113.0/24 or 203.0.113.25/32)

# ================================
# CONDITIONS
# ================================
Conditions:
  IsProduction: !Equals [!Ref Environment, 'production']
  IsStaging: !Equals [!Ref Environment, 'staging']
  IsDevelopment: !Equals [!Ref Environment, 'development']

Resources:
  # ================================
  # LOGGING & MONITORING
  # ================================
  ApplicationLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/apprunner/whatsapp-api-${Environment}'
      RetentionInDays: !If [IsProduction, 30, 7]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API

  # ================================
  # DATA STORAGE
  # ================================
  
  # DynamoDB Table for Message Deduplication
  MessageDeduplicationTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'whatsapp-dedup-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: msgid
          AttributeType: S
      KeySchema:
        - AttributeName: msgid
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Message-Deduplication

  # ================================
  # SQS QUEUES FOR MESSAGE PROCESSING
  # ================================
  
  # Incoming WhatsApp Messages Queue
  IncomingMessageQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'whatsapp-incoming-${Environment}'
      VisibilityTimeoutSeconds: 300  # 5 minutes for processing
      MessageRetentionPeriod: 1209600  # 14 days
      ReceiveMessageWaitTimeSeconds: 20  # Long polling
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt IncomingMessageDLQ.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Incoming-Message-Processing

  # Dead Letter Queue for Failed Incoming Messages
  IncomingMessageDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'whatsapp-incoming-dlq-${Environment}'
      MessageRetentionPeriod: 1209600  # 14 days
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Incoming-Message-DLQ

  # Outgoing WhatsApp Messages Queue
  OutgoingMessageQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'whatsapp-outgoing-${Environment}'
      VisibilityTimeoutSeconds: 60  # 1 minute for sending
      MessageRetentionPeriod: 1209600  # 14 days
      ReceiveMessageWaitTimeSeconds: 20  # Long polling
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt OutgoingMessageDLQ.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Outgoing-Message-Processing

  # Dead Letter Queue for Failed Outgoing Messages
  OutgoingMessageDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'whatsapp-outgoing-dlq-${Environment}'
      MessageRetentionPeriod: 1209600  # 14 days
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Outgoing-Message-DLQ

  # Analytics and Metrics Queue
  AnalyticsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'whatsapp-analytics-${Environment}'
      VisibilityTimeoutSeconds: 120  # 2 minutes for analytics processing
      MessageRetentionPeriod: 1209600  # 14 days
      ReceiveMessageWaitTimeSeconds: 20  # Long polling
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt AnalyticsDLQ.Arn
        maxReceiveCount: 5  # More retries for analytics
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Analytics-Processing

  # Dead Letter Queue for Failed Analytics
  AnalyticsDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'whatsapp-analytics-dlq-${Environment}'
      MessageRetentionPeriod: 1209600  # 14 days
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Analytics-DLQ

  # S3 Bucket for Data Storage and Archival
  WhatsAppDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'whatsapp-data-${Environment}-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: WhatsAppDataLifecycle
            Status: Enabled
            Prefix: messages/
            Transitions:
              - TransitionInDays: 90
                StorageClass: STANDARD_IA
              - TransitionInDays: 365
                StorageClass: GLACIER
              - TransitionInDays: 2555  # 7 years
                StorageClass: DEEP_ARCHIVE
            ExpirationInDays: 3650  # 10 years for compliance
          - Id: MediaLifecycle
            Status: Enabled
            Prefix: media/
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
              - TransitionInDays: 180
                StorageClass: GLACIER
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Data-Storage-Archive

  # ================================
  # SECURITY GROUPS
  # ================================

  # Security Group for RDS 
  DefaultVPCSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'whatsapp-rds-sg-${Environment}'
      GroupDescription: Security group for PostgreSQL access
      VpcId: !Ref DefaultVPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: !Ref AllowedCIDR
          Description: PostgreSQL access for App Runner service (restricted IP range)
      Tags:
        - Key: Name
          Value: !Sub 'whatsapp-rds-sg-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API

  # DB Parameter Group to enforce SSL
  PostgreSQLParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      DBParameterGroupName: !Sub 'whatsapp-postgres-params-${Environment}'
      Description: Parameter group for WhatsApp PostgreSQL with SSL enforcement
      Family: postgres15
      Parameters:
        rds.force_ssl: "1"  # Enforce SSL connections
        log_statement: "all"  # Log all statements for security monitoring
        log_min_duration_statement: "1000"  # Log slow queries (>1 second)
      Tags:
        - Key: Name
          Value: !Sub 'whatsapp-postgres-params-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API

  # ================================
  # DATABASE
  # ================================

  # RDS PostgreSQL Database (Publicly Accessible)
  PostgreSQLDB:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub 'whatsapp-postgres-${Environment}'
      DBName: !Sub 'whatsapp_business_${Environment}'
      Engine: postgres
      EngineVersion: '15.8'
      DBInstanceClass: !If [IsProduction, db.t3.small, db.t3.micro]
      AllocatedStorage: !If [IsProduction, 100, 20]
      StorageType: gp3
      MasterUsername: postgres
      ManageMasterUserPassword: true
      MasterUserSecret:
        KmsKeyId: alias/aws/secretsmanager
      EnableIAMDatabaseAuthentication: true
      VPCSecurityGroups:
        - !Ref DefaultVPCSecurityGroup  # Custom SG with restricted IP access
      DBParameterGroupName: !Ref PostgreSQLParameterGroup  # Enforce SSL
      # DBSubnetGroupName: removed - using default VPC default subnet group
      BackupRetentionPeriod: !If [IsProduction, 30, 7]
      MultiAZ: !If [IsProduction, true, false]
      PubliclyAccessible: true  # Required for App Runner to connect without VPC
      StorageEncrypted: true
      DeletionProtection: !If [IsProduction, true, false]
      Tags:
        - Key: Name
          Value: !Sub 'whatsapp-postgres-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API

  # ================================
  # IAM ROLES & POLICIES
  # ================================
  
  # IAM Role for App Runner Service
  AppRunnerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'AppRunnerWhatsAppRole-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: tasks.apprunner.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource: !GetAtt MessageDeduplicationTable.Arn
        - PolicyName: RDSIAMAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - rds-db:connect
                Resource: !Sub 'arn:${AWS::Partition}:rds-db:${AWS::Region}:${AWS::AccountId}:dbuser:${PostgreSQLDB.DbiResourceId}/app_user'
        - PolicyName: S3DataAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:GetObjectVersion
                Resource: !Sub '${WhatsAppDataBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:GetBucketLocation
                Resource: !GetAtt WhatsAppDataBucket.Arn
        - PolicyName: SQSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                  - sqs:GetQueueUrl
                  - sqs:ChangeMessageVisibility
                Resource:
                  - !GetAtt IncomingMessageQueue.Arn
                  - !GetAtt OutgoingMessageQueue.Arn
                  - !GetAtt AnalyticsQueue.Arn
                  - !GetAtt IncomingMessageDLQ.Arn
                  - !GetAtt OutgoingMessageDLQ.Arn
                  - !GetAtt AnalyticsDLQ.Arn
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API

  # ================================
  # APP RUNNER SERVICE
  # ================================
  
  # App Runner Service (No VPC - Direct Internet Access)
  WhatsAppAppRunner:
    Type: AWS::AppRunner::Service
    DependsOn: 
      - PostgreSQLDB
      - WhatsAppDataBucket
    Properties:
      ServiceName: !Sub 'whatsapp-api-${Environment}'
      SourceConfiguration:
        AuthenticationConfiguration:
          ConnectionArn: !Ref GitHubConnectionArn
        CodeRepository:
          RepositoryUrl: !Ref GitHubRepositoryUrl
          SourceCodeVersion:
            Type: BRANCH
            Value: !Ref GitHubBranch
          CodeConfiguration:
            ConfigurationSource: API
            CodeConfigurationValues:
              Runtime: PYTHON_3
              BuildCommand: pip install -r backend/requirements.txt
              StartCommand: uvicorn backend.app.main:app --host 0.0.0.0 --port 8000
              Port: 8000  
              RuntimeEnvironmentVariables:
                - Name: ENVIRONMENT
                  Value: !Ref Environment
                - Name: AWS_REGION
                  Value: !Ref AWS::Region
                - Name: LOG_LEVEL
                  Value: !If [IsProduction, 'INFO', 'DEBUG']
                - Name: DATABASE_URL
                  Value: !Sub 'postgresql://app_user@${PostgreSQLDB.Endpoint.Address}:${PostgreSQLDB.Endpoint.Port}/whatsapp_business_${Environment}'
                - Name: DB_HOST
                  Value: !GetAtt PostgreSQLDB.Endpoint.Address
                - Name: DB_PORT
                  Value: !GetAtt PostgreSQLDB.Endpoint.Port
                - Name: DB_NAME
                  Value: !Sub 'whatsapp_business_${Environment}'
                - Name: DB_USER
                  Value: 'app_user'
                - Name: USE_IAM_AUTH
                  Value: 'true'
                - Name: WHATSAPP_TOKEN
                  Value: !Ref WhatsAppToken
                - Name: VERIFY_TOKEN
                  Value: !Ref VerifyToken
                - Name: S3_DATA_BUCKET
                  Value: !Ref WhatsAppDataBucket
                - Name: DYNAMODB_TABLE
                  Value: !Ref MessageDeduplicationTable
                - Name: SQS_INCOMING_QUEUE_URL
                  Value: !Ref IncomingMessageQueue
                - Name: SQS_OUTGOING_QUEUE_URL
                  Value: !Ref OutgoingMessageQueue
                - Name: SQS_ANALYTICS_QUEUE_URL
                  Value: !Ref AnalyticsQueue
                - Name: SQS_INCOMING_DLQ_URL
                  Value: !Ref IncomingMessageDLQ
                - Name: SQS_OUTGOING_DLQ_URL
                  Value: !Ref OutgoingMessageDLQ
                - Name: SQS_ANALYTICS_DLQ_URL
                  Value: !Ref AnalyticsDLQ
        AutoDeploymentsEnabled: true
      InstanceConfiguration:
        Cpu: !If [IsProduction, '1 vCPU', '0.25 vCPU']
        Memory: !If [IsProduction, '2 GB', '0.5 GB']
        InstanceRoleArn: !GetAtt AppRunnerRole.Arn
      HealthCheckConfiguration:
        Protocol: HTTP
        Path: /health
        Interval: 30
        Timeout: 5
        HealthyThreshold: 2
        UnhealthyThreshold: 5
      # No NetworkConfiguration - App Runner uses direct internet access
      # This eliminates NAT Gateway costs (~$45-60/month savings)
      Tags:
        - Key: Name
          Value: !Sub 'whatsapp-api-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API

# ================================
# OUTPUTS
# ================================
Outputs:
  # Application Endpoints
  AppRunnerServiceUrl:
    Description: App Runner Service URL for WhatsApp webhook
    Value: !GetAtt WhatsAppAppRunner.ServiceUrl
  
  AppRunnerServiceArn:
    Description: App Runner Service ARN
    Value: !Ref WhatsAppAppRunner
    Export:
      Name: !Sub '${AWS::StackName}-AppRunnerServiceArn'

  # Database Information
  DatabaseEndpoint:
    Description: RDS PostgreSQL endpoint for IAM authentication
    Value: !GetAtt PostgreSQLDB.Endpoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-DatabaseEndpoint'

  DatabasePort:
    Description: RDS PostgreSQL port
    Value: !GetAtt PostgreSQLDB.Endpoint.Port
    Export:
      Name: !Sub '${AWS::StackName}-DatabasePort'

  DatabaseName:
    Description: PostgreSQL database name
    Value: !Sub 'whatsapp_business_${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-DatabaseName'

  # Storage Resources
  S3DataBucket:
    Description: S3 bucket for data storage and archival
    Value: !Ref WhatsAppDataBucket
    Export:
      Name: !Sub '${AWS::StackName}-S3DataBucket'

  DynamoDBTableName:
    Description: DynamoDB table name for message deduplication
    Value: !Ref MessageDeduplicationTable
    Export:
      Name: !Sub '${AWS::StackName}-DynamoDBTable'

  # Infrastructure Resources (Minimal without VPC)
  AppRunnerRoleArn:
    Description: IAM Role ARN for App Runner service
    Value: !GetAtt AppRunnerRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-AppRunnerRole'

  LogGroupName:
    Description: CloudWatch Log Group for application logs
    Value: !Ref ApplicationLogGroup
    Export:
      Name: !Sub '${AWS::StackName}-LogGroup'

  # SQS Queue Information
  IncomingQueueUrl:
    Description: SQS Queue URL for incoming WhatsApp messages
    Value: !Ref IncomingMessageQueue
    Export:
      Name: !Sub '${AWS::StackName}-IncomingQueue'

  OutgoingQueueUrl:
    Description: SQS Queue URL for outgoing WhatsApp messages
    Value: !Ref OutgoingMessageQueue
    Export:
      Name: !Sub '${AWS::StackName}-OutgoingQueue'

  AnalyticsQueueUrl:
    Description: SQS Queue URL for analytics processing
    Value: !Ref AnalyticsQueue
    Export:
      Name: !Sub '${AWS::StackName}-AnalyticsQueue'

  # Environment Summary
  EnvironmentSummary:
    Description: Summary of environment-specific configurations
    Value: !Sub |
      Environment: ${Environment}
      App Runner URL: ${WhatsAppAppRunner.ServiceUrl}
      Database: whatsapp_business_${Environment} 
      DynamoDB Table: ${MessageDeduplicationTable}
      S3 Bucket: ${WhatsAppDataBucket}
      SQS Queues: ${IncomingMessageQueue}, ${OutgoingMessageQueue}, ${AnalyticsQueue}
