AWSTemplateFormatVersion: '2010-09-09'
Description: 'WhatsApp Business API Infrastructure - Complete serverless stack with RDS, DynamoDB, S3, and App Runner'

# ================================
# PARAMETERS
# ================================
Parameters:
  Environment:
    Type: String
    Default: development
    AllowedValues: [development, staging, production]
    Description: Environment name (affects resource sizing and configuration)
  
  WhatsAppToken:
    Type: String
    NoEcho: true
    Description: WhatsApp Business API Token from Meta Developer Console
  
  VerifyToken:
    Type: String
    NoEcho: true
    Description: WhatsApp Webhook Verify Token for webhook validation
  
  WhatsAppPhoneNumberId:
    Type: String
    NoEcho: true
    Description: WhatsApp Business Phone Number ID from Meta Developer Console
  
  GitHubConnectionArn:
    Type: String
    Description: ARN of the App Runner connection to GitHub (create this manually in AWS Console first)
  
  GitHubRepositoryUrl:
    Type: String
    Description: Full GitHub repository URL
    Default: "https://github.com/therealabhishekc/goblin"
  
  GitHubBranch:
    Type: String
    Description: GitHub branch to deploy from
    Default: "main"

  DefaultVPCId:
    Type: AWS::EC2::VPC::Id
    Description: Default VPC ID (find this in AWS Console > VPC > Your VPCs)

  AllowedCIDR:
    Type: String
    Description: CIDR block to allow PostgreSQL access (use your office/VPN IP for security)
    Default: "0.0.0.0/0"
    AllowedPattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
    ConstraintDescription: Must be a valid CIDR block (e.g., 203.0.113.0/24 or 203.0.113.25/32)

  # Lambda Archival Parameters
  ArchiveThresholdDays:
    Type: Number
    Default: 90
    Description: Archive messages older than N days
    
  MediaThresholdDays:
    Type: Number
    Default: 30
    Description: Archive media files older than N days
    
  EnableArchival:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: Enable automated data archival (set to false to skip Lambda deployment)

# ================================
# CONDITIONS
# ================================
Conditions:
  IsProduction: !Equals [!Ref Environment, 'production']
  IsStaging: !Equals [!Ref Environment, 'staging']
  IsDevelopment: !Equals [!Ref Environment, 'development']
  EnableArchivalResources: !Equals [!Ref EnableArchival, 'true']

Resources:
  # ================================
  # SECRETS MANAGEMENT
  # ================================
  WhatsAppCredentialsSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub 'whatsapp-credentials-${Environment}'
      Description: WhatsApp Business API credentials and configuration
      SecretString: !Sub |
        {
          "WHATSAPP_TOKEN": "${WhatsAppToken}",
          "VERIFY_TOKEN": "${VerifyToken}",
          "PHONE_NUMBER_ID": "${WhatsAppPhoneNumberId}"
        }
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: API-Credentials

  # ================================
  # LOGGING & MONITORING
  # ================================
  ApplicationLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/apprunner/whatsapp-api-${Environment}'
      RetentionInDays: !If [IsProduction, 30, 7]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API

  # ================================
  # DATA STORAGE
  # ================================
  
  # DynamoDB Table for Message Deduplication
  MessageDeduplicationTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'whatsapp-dedup-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: msgid
          AttributeType: S
      KeySchema:
        - AttributeName: msgid
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Message-Deduplication

  # ================================
  # SQS QUEUES FOR MESSAGE PROCESSING
  # ================================
  
  # Incoming WhatsApp Messages Queue
  IncomingMessageQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'whatsapp-incoming-${Environment}'
      VisibilityTimeout: 300  # 5 minutes for processing
      MessageRetentionPeriod: 1209600  # 14 days
      ReceiveMessageWaitTimeSeconds: 20  # Long polling
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt IncomingMessageDLQ.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Incoming-Message-Processing

  # Dead Letter Queue for Failed Incoming Messages
  IncomingMessageDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'whatsapp-incoming-dlq-${Environment}'
      MessageRetentionPeriod: 1209600  # 14 days
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Incoming-Message-DLQ

  # Outgoing WhatsApp Messages Queue
  OutgoingMessageQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'whatsapp-outgoing-${Environment}'
      VisibilityTimeout: 60  # 1 minute for sending
      MessageRetentionPeriod: 1209600  # 14 days
      ReceiveMessageWaitTimeSeconds: 20  # Long polling
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt OutgoingMessageDLQ.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Outgoing-Message-Processing

  # Dead Letter Queue for Failed Outgoing Messages
  OutgoingMessageDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'whatsapp-outgoing-dlq-${Environment}'
      MessageRetentionPeriod: 1209600  # 14 days
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Outgoing-Message-DLQ

  # Analytics and Metrics Queue
  AnalyticsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'whatsapp-analytics-${Environment}'
      VisibilityTimeout: 120  # 2 minutes for analytics processing
      MessageRetentionPeriod: 1209600  # 14 days
      ReceiveMessageWaitTimeSeconds: 20  # Long polling
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt AnalyticsDLQ.Arn
        maxReceiveCount: 5  # More retries for analytics
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Analytics-Processing

  # Dead Letter Queue for Failed Analytics
  AnalyticsDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'whatsapp-analytics-dlq-${Environment}'
      MessageRetentionPeriod: 1209600  # 14 days
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Analytics-DLQ

  # S3 Bucket for Data Storage and Archival
  WhatsAppDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'whatsapp-data-${Environment}-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: WhatsAppDataLifecycle
            Status: Enabled
            Prefix: messages/
            Transitions:
              - TransitionInDays: 90
                StorageClass: STANDARD_IA
              - TransitionInDays: 365
                StorageClass: GLACIER
              - TransitionInDays: 2555  # 7 years
                StorageClass: DEEP_ARCHIVE
            ExpirationInDays: 3650  # 10 years for compliance
          - Id: MediaLifecycle
            Status: Enabled
            Prefix: media/
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
              - TransitionInDays: 180
                StorageClass: GLACIER
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API
        - Key: Purpose
          Value: Data-Storage-Archive

  # ================================
  # SECURITY GROUPS
  # ================================

  # Security Group for RDS 
  DefaultVPCSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub 'Security group for PostgreSQL access - ${Environment}'
      VpcId: !Ref DefaultVPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: !Ref AllowedCIDR
          Description: PostgreSQL access for App Runner service (restricted IP range)
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 0.0.0.0/0
          Description: PostgreSQL access for Lambda functions (IAM authenticated)
      Tags:
        - Key: Name
          Value: !Sub 'whatsapp-rds-sg-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API

  # DB Parameter Group to enforce SSL
  PostgreSQLParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: !Sub 'Parameter group for WhatsApp PostgreSQL with SSL enforcement - ${Environment}'
      Family: postgres15
      Parameters:
        rds.force_ssl: "1"  # Enforce SSL connections
        log_statement: "all"  # Log all statements for security monitoring
        log_min_duration_statement: "1000"  # Log slow queries (>1 second)
      Tags:
        - Key: Name
          Value: !Sub 'whatsapp-postgres-params-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API

  # ================================
  # DATABASE
  # ================================

  # RDS PostgreSQL Database (Publicly Accessible)
  PostgreSQLDB:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub 'whatsapp-postgres-${Environment}'
      DBName: !Sub 'whatsapp_business_${Environment}'
      Engine: postgres
      EngineVersion: '15.10'
      DBInstanceClass: !If [IsProduction, db.t3.small, db.t3.micro]
      AllocatedStorage: !If [IsProduction, 20, 20]
      StorageType: gp3
      MasterUsername: postgres
      ManageMasterUserPassword: true
      MasterUserSecret:
        KmsKeyId: alias/aws/secretsmanager
      EnableIAMDatabaseAuthentication: true
      VPCSecurityGroups:
        - !Ref DefaultVPCSecurityGroup  # Custom SG with restricted IP access
      DBParameterGroupName: !Ref PostgreSQLParameterGroup  # Enforce SSL
      # DBSubnetGroupName: removed - using default VPC default subnet group
      BackupRetentionPeriod: !If [IsProduction, 30, 7]
      MultiAZ: !If [IsProduction, false, false]
      PubliclyAccessible: true  # Required for App Runner to connect without VPC
      StorageEncrypted: true
      DeletionProtection: !If [IsProduction, false, false]
      Tags:
        - Key: Name
          Value: !Sub 'whatsapp-postgres-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API

  # ================================
  # IAM ROLES & POLICIES
  # ================================
  
  # IAM Role for App Runner Service
  AppRunnerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'AppRunnerWhatsAppRole-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: tasks.apprunner.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                Resource: !Ref WhatsAppCredentialsSecret
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource: !GetAtt MessageDeduplicationTable.Arn
        - PolicyName: RDSIAMAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - rds-db:connect
                Resource: !Sub 'arn:${AWS::Partition}:rds-db:${AWS::Region}:${AWS::AccountId}:dbuser:${PostgreSQLDB.DbiResourceId}/app_user'
        - PolicyName: S3DataAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:GetObjectVersion
                Resource: !Sub '${WhatsAppDataBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:GetBucketLocation
                Resource: !GetAtt WhatsAppDataBucket.Arn
        - PolicyName: SQSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                  - sqs:GetQueueUrl
                  - sqs:ChangeMessageVisibility
                Resource:
                  - !GetAtt IncomingMessageQueue.Arn
                  - !GetAtt OutgoingMessageQueue.Arn
                  - !GetAtt AnalyticsQueue.Arn
                  - !GetAtt IncomingMessageDLQ.Arn
                  - !GetAtt OutgoingMessageDLQ.Arn
                  - !GetAtt AnalyticsDLQ.Arn
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API

  # ================================
  # APP RUNNER SERVICE
  # ================================
  
  # App Runner Service (No VPC - Direct Internet Access)
  WhatsAppAppRunner:
    Type: AWS::AppRunner::Service
    DependsOn: 
      - PostgreSQLDB
      - WhatsAppDataBucket
    Properties:
      ServiceName: !Sub 'whatsapp-api-${Environment}'
      SourceConfiguration:
        AuthenticationConfiguration:
          ConnectionArn: !Ref GitHubConnectionArn
        AutoDeploymentsEnabled: true
        CodeRepository:
          RepositoryUrl: !Ref GitHubRepositoryUrl
          SourceCodeVersion:
            Type: BRANCH
            Value: !Ref GitHubBranch
          CodeConfiguration:
            ConfigurationSource: API
            CodeConfigurationValues:
              Runtime: PYTHON_3
              BuildCommand: pip install -r backend/requirements.txt
              StartCommand: python backend/start.py
              Port: "8000"
              RuntimeEnvironmentVariables:
                - Name: ENVIRONMENT
                  Value: !Ref Environment
                - Name: AWS_REGION
                  Value: !Ref AWS::Region
                - Name: LOG_LEVEL
                  Value: !If [IsProduction, 'INFO', 'INFO']
                - Name: DATABASE_URL
                  Value: !Sub 'postgresql://app_user@${PostgreSQLDB.Endpoint.Address}:${PostgreSQLDB.Endpoint.Port}/whatsapp_business_${Environment}?sslmode=require'
                - Name: DB_HOST
                  Value: !GetAtt PostgreSQLDB.Endpoint.Address
                - Name: DB_PORT
                  Value: !Sub '${PostgreSQLDB.Endpoint.Port}'
                - Name: DB_NAME
                  Value: !Sub 'whatsapp_business_${Environment}'
                - Name: DB_USER
                  Value: 'app_user'
                - Name: USE_IAM_AUTH
                  Value: 'true'
                - Name: WHATSAPP_SECRETS_NAME
                  Value: !Ref WhatsAppCredentialsSecret
                - Name: S3_DATA_BUCKET
                  Value: !Ref WhatsAppDataBucket
                - Name: DYNAMODB_TABLE
                  Value: !Ref MessageDeduplicationTable
                - Name: INCOMING_QUEUE_URL
                  Value: !Ref IncomingMessageQueue
                - Name: OUTGOING_QUEUE_URL
                  Value: !Ref OutgoingMessageQueue
                - Name: ANALYTICS_QUEUE_URL
                  Value: !Ref AnalyticsQueue
                - Name: INCOMING_DLQ_URL
                  Value: !Ref IncomingMessageDLQ
                - Name: OUTGOING_DLQ_URL
                  Value: !Ref OutgoingMessageDLQ
                - Name: ANALYTICS_DLQ_URL
                  Value: !Ref AnalyticsDLQ
      InstanceConfiguration:
        Cpu: !If [IsProduction, '2 vCPU', '1 vCPU']
        Memory: !If [IsProduction, '4 GB', '2 GB']
        InstanceRoleArn: !GetAtt AppRunnerRole.Arn
      HealthCheckConfiguration:
        Protocol: HTTP
        Path: /health
        Interval: 20
        Timeout: 5
        HealthyThreshold: 2
        UnhealthyThreshold: 5
      # No NetworkConfiguration - App Runner uses direct internet access
      # This eliminates NAT Gateway costs (~$45-60/month savings)
      Tags:
        - Key: Name
          Value: !Sub 'whatsapp-api-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API

  # ================================
  # LAMBDA ARCHIVAL FUNCTIONS
  # ================================
  
  # Lambda Execution Role for Archival Functions
  LambdaArchivalExecutionRole:
    Type: AWS::IAM::Role
    Condition: EnableArchivalResources
    Properties:
      RoleName: !Sub '${Environment}-whatsapp-lambda-archival-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SecretsManagerArchivalAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                Resource: !Ref WhatsAppCredentialsSecret
        - PolicyName: S3ArchivalPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                  - s3:GetBucketLocation
                Resource:
                  - !Sub '${WhatsAppDataBucket.Arn}'
                  - !Sub '${WhatsAppDataBucket.Arn}/*'
        - PolicyName: RDSArchivalPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - rds-db:connect
                Resource: !Sub 'arn:${AWS::Partition}:rds-db:${AWS::Region}:${AWS::AccountId}:dbuser:${PostgreSQLDB.DbiResourceId}/app_user'
        - PolicyName: SQSArchivalPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource: !GetAtt ArchivalDLQ.Arn
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: WhatsApp-Business-API

  # Message Archival Lambda Function
  MessageArchivalFunction:
    Type: AWS::Lambda::Function
    Condition: EnableArchivalResources
    Properties:
      FunctionName: !Sub '${Environment}-whatsapp-message-archival'
      Runtime: python3.9
      Handler: handler.lambda_handler
      Role: !GetAtt LambdaArchivalExecutionRole.Arn
      Code:
        ZipFile: |
          # Placeholder code - will be updated during deployment
          import json
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({
                      'message': 'Lambda function created - code will be updated during deployment',
                      'event': event
                  })
              }
      Timeout: 900  # 15 minutes
      MemorySize: 1024
      Environment:
        Variables:
          S3_DATA_BUCKET: !Ref WhatsAppDataBucket
          DATABASE_URL: !Sub 'postgresql://app_user@${PostgreSQLDB.Endpoint.Address}:${PostgreSQLDB.Endpoint.Port}/whatsapp_business_${Environment}?sslmode=require'
          ARCHIVE_THRESHOLD_DAYS: !Ref ArchiveThresholdDays
          ENVIRONMENT: !Ref Environment
          BATCH_SIZE: '1000'
          WHATSAPP_SECRETS_NAME: !Ref WhatsAppCredentialsSecret
      DeadLetterConfig:
        TargetArn: !GetAtt ArchivalDLQ.Arn
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: whatsapp-business-api
        - Key: Function
          Value: message-archival

  # Media Archival Lambda Function
  MediaArchivalFunction:
    Type: AWS::Lambda::Function
    Condition: EnableArchivalResources
    Properties:
      FunctionName: !Sub '${Environment}-whatsapp-media-archival'
      Runtime: python3.9
      Handler: handler.lambda_handler
      Role: !GetAtt LambdaArchivalExecutionRole.Arn
      Code:
        ZipFile: |
          # Placeholder code - will be updated during deployment
          import json
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({
                      'message': 'Lambda function created - code will be updated during deployment',
                      'event': event
                  })
              }
      Timeout: 900  # 15 minutes
      MemorySize: 2048
      Environment:
        Variables:
          S3_DATA_BUCKET: !Ref WhatsAppDataBucket
          DATABASE_URL: !Sub 'postgresql://app_user@${PostgreSQLDB.Endpoint.Address}:${PostgreSQLDB.Endpoint.Port}/whatsapp_business_${Environment}?sslmode=require'
          MEDIA_THRESHOLD_DAYS: !Ref MediaThresholdDays
          ENVIRONMENT: !Ref Environment
          BATCH_SIZE: '50'
          WHATSAPP_SECRETS_NAME: !Ref WhatsAppCredentialsSecret
      DeadLetterConfig:
        TargetArn: !GetAtt ArchivalDLQ.Arn
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: whatsapp-business-api
        - Key: Function
          Value: media-archival

  # Agent Expiration Lambda Function
  AgentExpirationFunction:
    Type: AWS::Lambda::Function
    Condition: EnableArchivalResources
    Properties:
      FunctionName: !Sub '${Environment}-whatsapp-agent-expiration'
      Runtime: python3.9
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaArchivalExecutionRole.Arn
      Code:
        ZipFile: |
          # Placeholder code - will be updated during deployment
          import json
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({
                      'message': 'Lambda function created - code will be updated during deployment',
                      'event': event
                  })
              }
      Timeout: 300  # 5 minutes
      MemorySize: 512
      Environment:
        Variables:
          DB_HOST: !GetAtt PostgreSQLDB.Endpoint.Address
          DB_PORT: !GetAtt PostgreSQLDB.Endpoint.Port
          DB_NAME: !Sub 'whatsapp_business_${Environment}'
          DB_USER: 'app_user'
          DB_PASSWORD: ''  # Will be set via Secrets Manager or parameter
          WHATSAPP_API_URL: !Sub 'https://${AppRunnerServiceUrl}'
          ENVIRONMENT: !Ref Environment
      DeadLetterConfig:
        TargetArn: !GetAtt ArchivalDLQ.Arn
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: whatsapp-business-api
        - Key: Function
          Value: agent-expiration

  # EventBridge Rules for Scheduling
  MessageArchivalScheduleRule:
    Type: AWS::Events::Rule
    Condition: EnableArchivalResources
    Properties:
      Name: !Sub '${Environment}-whatsapp-message-archival-schedule'
      Description: 'Trigger message archival every 2 days at 2 AM UTC'
      ScheduleExpression: 'cron(0 2 */2 * ? *)'
      State: ENABLED
      Targets:
        - Arn: !GetAtt MessageArchivalFunction.Arn
          Id: MessageArchivalTarget
          Input: !Sub |
            {
              "job_type": "messages",
              "scheduled": true,
              "environment": "${Environment}",
              "trigger_time": "scheduled_every_2_days"
            }

  MediaArchivalScheduleRule:
    Type: AWS::Events::Rule
    Condition: EnableArchivalResources
    Properties:
      Name: !Sub '${Environment}-whatsapp-media-archival-schedule'
      Description: 'Trigger media archival every 5 minutes'
      ScheduleExpression: 'rate(5 minutes)'
      State: ENABLED
      Targets:
        - Arn: !GetAtt MediaArchivalFunction.Arn
          Id: MediaArchivalTarget
          Input: !Sub |
            {
              "job_type": "media",
              "scheduled": true,
              "environment": "${Environment}",
              "trigger_time": "scheduled_every_5_minuites"
            }

  AgentExpirationScheduleRule:
    Type: AWS::Events::Rule
    Condition: EnableArchivalResources
    Properties:
      Name: !Sub '${Environment}-whatsapp-agent-expiration-schedule'
      Description: 'Trigger agent session expiration check every 5 minutes'
      ScheduleExpression: 'rate(5 minutes)'
      State: ENABLED
      Targets:
        - Arn: !GetAtt AgentExpirationFunction.Arn
          Id: AgentExpirationTarget
          Input: !Sub |
            {
              "job_type": "agent_expiration",
              "scheduled": true,
              "environment": "${Environment}",
              "trigger_time": "scheduled_every_5_minutes"
            }

  # Lambda Permissions for EventBridge
  MessageArchivalInvokePermission:
    Type: AWS::Lambda::Permission
    Condition: EnableArchivalResources
    Properties:
      FunctionName: !Ref MessageArchivalFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt MessageArchivalScheduleRule.Arn

  MediaArchivalInvokePermission:
    Type: AWS::Lambda::Permission
    Condition: EnableArchivalResources
    Properties:
      FunctionName: !Ref MediaArchivalFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt MediaArchivalScheduleRule.Arn

  AgentExpirationInvokePermission:
    Type: AWS::Lambda::Permission
    Condition: EnableArchivalResources
    Properties:
      FunctionName: !Ref AgentExpirationFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt AgentExpirationScheduleRule.Arn

  # Dead Letter Queue for Archival Functions
  ArchivalDLQ:
    Type: AWS::SQS::Queue
    Condition: EnableArchivalResources
    Properties:
      QueueName: !Sub '${Environment}-whatsapp-archival-dlq'
      MessageRetentionPeriod: 1209600  # 14 days
      VisibilityTimeout: 60
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: whatsapp-business-api

  # CloudWatch Alarms for Archival Functions
  MessageArchivalErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: EnableArchivalResources
    Properties:
      AlarmName: !Sub '${Environment}-whatsapp-message-archival-errors'
      AlarmDescription: 'Alert when message archival Lambda function has errors'
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref MessageArchivalFunction
      TreatMissingData: notBreaching

  MediaArchivalErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: EnableArchivalResources
    Properties:
      AlarmName: !Sub '${Environment}-whatsapp-media-archival-errors'
      AlarmDescription: 'Alert when media archival Lambda function has errors'
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref MediaArchivalFunction
      TreatMissingData: notBreaching

  AgentExpirationErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: EnableArchivalResources
    Properties:
      AlarmName: !Sub '${Environment}-whatsapp-agent-expiration-errors'
      AlarmDescription: 'Alert when agent expiration Lambda function has errors'
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref AgentExpirationFunction
      TreatMissingData: notBreaching

  # CloudWatch Log Groups for Lambda Functions
  MessageArchivalLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: EnableArchivalResources
    Properties:
      LogGroupName: !Sub '/aws/lambda/${Environment}-whatsapp-message-archival'
      RetentionInDays: 14

  MediaArchivalLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: EnableArchivalResources
    Properties:
      LogGroupName: !Sub '/aws/lambda/${Environment}-whatsapp-media-archival'
      RetentionInDays: 14

  AgentExpirationLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: EnableArchivalResources
    Properties:
      LogGroupName: !Sub '/aws/lambda/${Environment}-whatsapp-agent-expiration'
      RetentionInDays: 14

  # ================================
  # MARKETING CAMPAIGN SCHEDULER
  # ================================
  
  # Lambda Function for Campaign Processing
  CampaignProcessorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${Environment}-campaign-processor'
      Description: 'Invokes App Runner endpoint for daily campaign processing'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt CampaignProcessorRole.Arn
      Timeout: 300  # 5 minutes
      Environment:
        Variables:
          APP_RUNNER_URL: !GetAtt WhatsAppAppRunner.ServiceUrl
          ENVIRONMENT: !Ref Environment
      Code:
        ZipFile: |
          import json
          import urllib3
          import os
          
          http = urllib3.PoolManager()
          
          def lambda_handler(event, context):
              """
              Invoke App Runner endpoint for daily campaign processing
              """
              app_runner_url = os.environ.get('APP_RUNNER_URL')
              endpoint = f"https://{app_runner_url}/marketing/process-daily"
              
              print(f"Invoking campaign processing: {endpoint}")
              
              try:
                  response = http.request(
                      'POST',
                      endpoint,
                      headers={
                          'Content-Type': 'application/json',
                      },
                      timeout=290.0  # Slightly less than Lambda timeout
                  )
                  
                  response_data = json.loads(response.data.decode('utf-8'))
                  
                  print(f"Response status: {response.status}")
                  print(f"Response data: {response_data}")
                  
                  return {
                      'statusCode': response.status,
                      'body': json.dumps({
                          'message': 'Campaign processing completed',
                          'result': response_data
                      })
                  }
                  
              except Exception as e:
                  print(f"Error invoking campaign processor: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps({
                          'error': str(e)
                      })
                  }
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: whatsapp-business-api
        - Key: Function
          Value: campaign-processing
  
  # IAM Role for Campaign Processor Lambda
  CampaignProcessorRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${Environment}-campaign-processor-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: AppRunnerInvokePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - apprunner:DescribeService
                  - apprunner:ListServices
                Resource: '*'
      Tags:
        - Key: Environment
          Value: !Ref Environment
  
  # EventBridge Rule to trigger Lambda for campaign processing
  DailyCampaignScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${Environment}-daily-campaign-processing'
      Description: 'Trigger campaign processing every 5 minutes for testing'
      ScheduleExpression: 'rate(5 minutes)'  # Every 5 minutes for testing
      # For production use: 'cron(0 9 * * ? *)'  # 9 AM UTC daily
      State: ENABLED
      Targets:
        - Arn: !GetAtt CampaignProcessorFunction.Arn
          Id: CampaignProcessorTarget
          Input: !Sub |
            {
              "scheduled": true,
              "environment": "${Environment}",
              "trigger_time": "every_5_minutes_testing"
            }
  
  # Permission for EventBridge to invoke Campaign Processor Lambda
  CampaignProcessorInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CampaignProcessorFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt DailyCampaignScheduleRule.Arn
  
  # CloudWatch Alarm for Campaign Processing Errors
  CampaignProcessorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${Environment}-campaign-processor-errors'
      AlarmDescription: 'Alert when campaign processor Lambda function has errors'
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref CampaignProcessorFunction
      TreatMissingData: notBreaching
  
  # CloudWatch Log Group for Campaign Processor
  CampaignProcessorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${Environment}-campaign-processor'
      RetentionInDays: 14

# ================================
# OUTPUTS
# ================================
Outputs:
  # Application Endpoints
  AppRunnerServiceUrl:
    Description: App Runner Service URL for WhatsApp webhook
    Value: !GetAtt WhatsAppAppRunner.ServiceUrl
  
  AppRunnerServiceArn:
    Description: App Runner Service ARN
    Value: !Ref WhatsAppAppRunner
    Export:
      Name: !Sub '${AWS::StackName}-AppRunnerServiceArn'

  # Database Information
  DatabaseEndpoint:
    Description: RDS PostgreSQL endpoint for IAM authentication
    Value: !GetAtt PostgreSQLDB.Endpoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-DatabaseEndpoint'

  DatabasePort:
    Description: RDS PostgreSQL port
    Value: !GetAtt PostgreSQLDB.Endpoint.Port
    Export:
      Name: !Sub '${AWS::StackName}-DatabasePort'

  DatabaseName:
    Description: PostgreSQL database name
    Value: !Sub 'whatsapp_business_${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-DatabaseName'

  # Storage Resources
  S3DataBucket:
    Description: S3 bucket for data storage and archival
    Value: !Ref WhatsAppDataBucket
    Export:
      Name: !Sub '${AWS::StackName}-S3DataBucket'

  DynamoDBTableName:
    Description: DynamoDB table name for message deduplication
    Value: !Ref MessageDeduplicationTable
    Export:
      Name: !Sub '${AWS::StackName}-DynamoDBTable'

  # Infrastructure Resources (Minimal without VPC)
  AppRunnerRoleArn:
    Description: IAM Role ARN for App Runner service
    Value: !GetAtt AppRunnerRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-AppRunnerRole'

  LogGroupName:
    Description: CloudWatch Log Group for application logs
    Value: !Ref ApplicationLogGroup
    Export:
      Name: !Sub '${AWS::StackName}-LogGroup'

  # SQS Queue Information
  IncomingQueueUrl:
    Description: SQS Queue URL for incoming WhatsApp messages
    Value: !Ref IncomingMessageQueue
    Export:
      Name: !Sub '${AWS::StackName}-IncomingQueue'

  OutgoingQueueUrl:
    Description: SQS Queue URL for outgoing WhatsApp messages
    Value: !Ref OutgoingMessageQueue
    Export:
      Name: !Sub '${AWS::StackName}-OutgoingQueue'

  AnalyticsQueueUrl:
    Description: SQS Queue URL for analytics processing
    Value: !Ref AnalyticsQueue
    Export:
      Name: !Sub '${AWS::StackName}-AnalyticsQueue'

  # Lambda Archival Functions (Conditional)
  MessageArchivalFunctionArn:
    Description: ARN of the message archival Lambda function
    Condition: EnableArchivalResources
    Value: !GetAtt MessageArchivalFunction.Arn
    Export:
      Name: !Sub '${Environment}-whatsapp-message-archival-function-arn'

  MediaArchivalFunctionArn:
    Description: ARN of the media archival Lambda function
    Condition: EnableArchivalResources
    Value: !GetAtt MediaArchivalFunction.Arn
    Export:
      Name: !Sub '${Environment}-whatsapp-media-archival-function-arn'

  AgentExpirationFunctionArn:
    Description: ARN of the agent expiration Lambda function
    Condition: EnableArchivalResources
    Value: !GetAtt AgentExpirationFunction.Arn
    Export:
      Name: !Sub '${Environment}-whatsapp-agent-expiration-function-arn'

  ArchivalScheduleEnabled:
    Description: Whether archival scheduling is enabled
    Value: !Ref EnableArchival
    Export:
      Name: !Sub '${Environment}-archival-enabled'

  # Security Resources
  SecretsManagerSecretName:
    Description: Name of the AWS Secrets Manager secret containing WhatsApp credentials
    Value: !Ref WhatsAppCredentialsSecret
    Export:
      Name: !Sub '${AWS::StackName}-WhatsAppSecrets'

  # Environment Summary
  EnvironmentSummary:
    Description: Summary of environment-specific configurations
    Value: !Sub |
      Environment: ${Environment}
      App Runner URL: ${WhatsAppAppRunner.ServiceUrl}
      Database: whatsapp_business_${Environment} 
      DynamoDB Table: ${MessageDeduplicationTable}
      S3 Bucket: ${WhatsAppDataBucket}
      SQS Queues: ${IncomingMessageQueue}, ${OutgoingMessageQueue}, ${AnalyticsQueue}
      Archival: ${EnableArchival} (Messages: ${ArchiveThresholdDays}d, Media: ${MediaThresholdDays}d)
      Secrets: ${WhatsAppCredentialsSecret}
  
  # Campaign Processing Resources
  CampaignProcessorFunctionArn:
    Description: Campaign Processor Lambda Function ARN
    Value: !GetAtt CampaignProcessorFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CampaignProcessorArn'
  
  DailyCampaignSchedule:
    Description: Daily campaign processing schedule (EventBridge Rule)
    Value: !Ref DailyCampaignScheduleRule
  
  CampaignProcessingTime:
    Description: Campaign processing schedule
    Value: 'Every 5 minutes (for testing) - Change to cron(0 9 * * ? *) for production (9 AM UTC daily)'
