# ðŸ”’ RACE-SAFE Environment Configuration
# These environment variables configure race condition prevention mechanisms

# =============================================================================
# ðŸ”’ DynamoDB Configuration (RACE-SAFE DEDUPLICATION)
# =============================================================================
# DynamoDB table for atomic message deduplication
DYNAMODB_TABLE_NAME=whatsapp-dedup-prod
AWS_REGION=us-east-1

# =============================================================================
# ðŸ”’ SQS Configuration (RACE-SAFE MESSAGE QUEUING)
# =============================================================================
# Main queues for message processing
INCOMING_QUEUE_URL=https://sqs.us-east-1.amazonaws.com/YOUR-ACCOUNT/whatsapp-incoming
OUTGOING_QUEUE_URL=https://sqs.us-east-1.amazonaws.com/YOUR-ACCOUNT/whatsapp-outgoing
ANALYTICS_QUEUE_URL=https://sqs.us-east-1.amazonaws.com/YOUR-ACCOUNT/whatsapp-analytics

# Dead Letter Queues for failed messages
INCOMING_DLQ_URL=https://sqs.us-east-1.amazonaws.com/YOUR-ACCOUNT/whatsapp-incoming-dlq
OUTGOING_DLQ_URL=https://sqs.us-east-1.amazonaws.com/YOUR-ACCOUNT/whatsapp-outgoing-dlq
ANALYTICS_DLQ_URL=https://sqs.us-east-1.amazonaws.com/YOUR-ACCOUNT/whatsapp-analytics-dlq

# ðŸ”’ Race-Safe SQS Settings (PREVENTS PROCESSOR RACES)
SQS_VISIBILITY_TIMEOUT=900      # 15 minutes - prevents multiple processors from seeing same message
SQS_MAX_RECEIVE_COUNT=3         # Before sending to DLQ - prevents infinite retries
SQS_WAIT_TIME_SECONDS=20        # Long polling - reduces API calls and improves efficiency

# =============================================================================
# ðŸ”’ Race Condition Prevention Explanation
# =============================================================================

# SQS_VISIBILITY_TIMEOUT=900 (15 minutes)
# Purpose: Prevents race conditions between multiple message processors
# How it works:
#   - When a processor receives a message, it becomes invisible to other processors for 15 minutes
#   - This prevents multiple processors from processing the same message simultaneously
#   - If processing takes longer than 15 minutes, the visibility timeout is extended
#   - If processor crashes, message becomes visible again after timeout for retry

# SQS_MAX_RECEIVE_COUNT=3 (Before DLQ)
# Purpose: Prevents infinite retry loops for permanently failing messages
# How it works:
#   - If a message fails processing 3 times, it's moved to Dead Letter Queue (DLQ)
#   - Prevents race conditions where failing messages keep bouncing between processors
#   - DLQ messages can be analyzed and reprocessed manually after fixing issues

# SQS_WAIT_TIME_SECONDS=20 (Long polling)
# Purpose: Reduces race conditions and improves efficiency
# How it works:
#   - Processor waits up to 20 seconds for messages instead of continuously polling
#   - Reduces API calls and prevents processors from competing for same messages
#   - More efficient than short polling which can cause processor races
#   - Enables better load distribution across multiple processor instances

# =============================================================================
# Additional Notes
# =============================================================================
# - All processors use unique UUIDs to identify themselves in DynamoDB
# - Messages are atomically claimed using DynamoDB conditional updates  
# - Only the processor that owns a message can update its status
# - Visibility timeouts are extended during processing to prevent races
# - Failed messages retry with exponential backoff to prevent tight loops